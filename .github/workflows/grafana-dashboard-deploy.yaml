name: Deploy Grafana Dashboard

on:
  workflow_call:
    inputs:
      file_path:
        required: false
        type: string
        default: ./main.jsonnet
    secrets:
      GRAFANA_URL:
        required: true
      GRAFANA_TOKEN:
        required: true
      GH_TOKEN:
        required: true

jobs:
  deploy_grafana_dashboard:
    name: Deploy Grafana Dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Install Jsonnet Bundler
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: jsonnet-bundler/jsonnet-bundler
          platform: linux
          arch: x86-64

      - name: Install Grizzly
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: grafana/grizzly
          platform: linux
          arch: x86-64

      - name: Deploy dashboards
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          jb install
          grr apply ${{ inputs.file_path }}
