name: Previews Grafana Dashboard

on:
  workflow_call:
    inputs:
      file_path:
        required: false
        type: string
        default: ./main.jsonnet
      snapshot_expiry_seconds:
        required: false
        type: number
        default: 86400
    secrets:
      GRAFANA_URL:
        required: true
      GRAFANA_TOKEN:
        required: true
      GH_TOKEN:
        required: true

jobs:
  preview_grafana_dashboard:
    name: Preview Grafana Dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Install Jsonnet Bundler
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: jsonnet-bundler/jsonnet-bundler
          platform: linux
          arch: x86-64

      - name: Install Grizzly
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: grafana/grizzly
          platform: linux
          arch: x86-64

      - name: Create Snapshots
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          jb install
          grr preview --expires ${{ inputs.snapshot_expiry_seconds }} ${{ inputs.file_path }} > urls
          echo '::group::Grafana Preview'
          cat urls
          echo '::endgroup::'
          echo 'PREVIEW_URLS<<EOF' >> $GITHUB_ENV
          cat urls | grep view | sed 's/Dashboard\./[/;s/ view: /](/;s/$/)/') >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Comment Preview URLs in PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            Grafana Dashboard Previews:

            ${{ env.PREVIEW_URLS }}
          comment_includes: "Grafana Dashboard Previews:"
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
