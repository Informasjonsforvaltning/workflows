name: Reusable nox build, test, publish & deploy

on:
  workflow_call:
    inputs:
      actor:
        required: false
        type: string
        default: ${{ github.actor }}
      app_name:
        required: true
        type: string
      caller_sha:
        required: false
        type: string
        default: ${{ github.sha }}
      cluster:
        required: true
        type: string
      dockerfile:
        required: false
        type: string
        default: ./Dockerfile
      dockerfile_context:
        required: false
        type: string
        default: ./
      environment:
        required: true
        type: string
      node_version:
        required: false
        type: number
        default: 0
      nox_cmd:
        required: false
        type: string
      nox_env:
        required: false
        type: number
        default: 0
      nox_env_1_name:
        required: false
        type: string
        default: default_1
      nox_env_2_name:
        required: false
        type: string
        default: default_2
      nox_env_3_name:
        required: false
        type: string
        default: default_3
      nox_env_4_name:
        required: false
        type: string
        default: default_4
      nox_image:
        required: false
        type: boolean
      python_version:
        required: true
        type: string
      python_architecture:
        required: true
        type: string
      repo:
        required: false
        type: string
        default: ${{ github.repository }}
      run_safety:
        required: false
        type: boolean
      set_es_map_count:
        required: false
        type: boolean
      snapshot_disk:
        required: false
        type: string
      snapshot_name:
        required: false
        type: string
      snapshot_zone:
        required: false
        type: string
    secrets:
      GH_TOKEN:
        required: true

jobs:
  analyze:
    name: Analyze source code
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}
          architecture: ${{ inputs.python_architecture}}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
